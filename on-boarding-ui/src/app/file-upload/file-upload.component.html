<div class="file-upload-container">
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="title-icon">cloud_upload</mat-icon>
        File Upload
      </mat-card-title>
      <mat-card-subtitle>
        Upload multiple files by dragging and dropping or clicking the button below
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Drag and Drop Area -->
      <div 
        class="drop-zone"
        [class.drag-over]="isDragOver"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
      >
        <div class="drop-zone-content">
          <mat-icon class="drop-icon">cloud_upload</mat-icon>
          <h3>Drag & Drop Files Here</h3>
          <p>or</p>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="fileInput.click()"
            class="upload-button"
          >
            <mat-icon>file_upload</mat-icon>
            Choose Files
          </button>
          <input 
            #fileInput
            type="file" 
            multiple 
            (change)="onFileSelected($event)"
            style="display: none;"
            accept=".pdf"
          >
          <div class="file-info">
            <p><strong>Supported formats:</strong> PDF </p>
            <p><strong>Maximum file size:</strong> 10MB per file</p>
          </div>
        </div>
      </div>

      <!-- File List -->
      <div class="file-list" *ngIf="uploadedFiles.length > 0">
        <div class="file-list-header">
          <h3>Uploaded Files ({{ uploadedFiles.length }})</h3>
          <div class="submit-section">
            <button 
              mat-raised-button 
              color="accent" 
              [disabled]="!canSubmit()"
              (click)="submitFiles()"
              class="submit-button"
            >
              <mat-icon>send</mat-icon>
              Submit Files ({{ getCompletedFilesCount() }})
            </button>
          </div>
        </div>
        
        <mat-list>
          <mat-list-item *ngFor="let uploadedFile of uploadedFiles; let i = index" class="file-item">
            <div class="file-item-content">
              <div class="file-info">
                <mat-icon class="file-icon" [class]="uploadedFile.status">
                  {{ getFileIcon(uploadedFile.file.type) }}
                </mat-icon>
                <div class="file-details">
                  <div class="file-name">{{ uploadedFile.file.name }}</div>
                  <div class="file-meta">
                    {{ formatFileSize(uploadedFile.file.size) }} • 
                    <span class="status" [class]="uploadedFile.status">
                      {{ uploadedFile.status | titlecase }}
                    </span>
                  </div>
                </div>
              </div>

              <div class="file-actions">
                <!-- Status Icons -->
                <mat-icon 
                  *ngIf="uploadedFile.status === 'completed'" 
                  class="status-icon success"
                >
                  check_circle
                </mat-icon>
                <mat-icon 
                  *ngIf="uploadedFile.status === 'error'" 
                  class="status-icon error"
                >
                  error
                </mat-icon>

                <!-- Action Buttons -->
                <button 
                  mat-icon-button 
                  *ngIf="uploadedFile.status === 'error'"
                  (click)="retryUpload(uploadedFile)"
                  matTooltip="Retry upload"
                >
                  <mat-icon>refresh</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  (click)="removeFile(i)"
                  matTooltip="Remove file"
                  class="remove-button"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-list-item>
        </mat-list>

        <!-- Submit Progress -->
        <div class="submit-progress" *ngIf="isSubmitting">
          <div class="progress-header">
            <h4>Submitting Files...</h4>
            <span class="progress-text">{{ submitProgress }}%</span>
          </div>
          <mat-progress-bar 
            [value]="submitProgress" 
            class="submit-progress-bar"
          ></mat-progress-bar>
        </div>
      </div>

      <!-- File Details Table -->
      <div class="file-table-section" *ngIf="showFileTable && getCompletedFiles().length > 0">
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon class="table-icon">table_chart</mat-icon>
              File Details
            </mat-card-title>
            <mat-card-subtitle>
              Configure file types and SOR codes for uploaded files
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <table mat-table [dataSource]="getTableData()" class="file-table">
              <!-- File Name Column -->
              <ng-container matColumnDef="fileName">
                <th mat-header-cell *matHeaderCellDef>File Name</th>
                <td mat-cell *matCellDef="let file">
                  <div class="file-name-cell">
                    <mat-icon class="file-icon">{{ getFileIcon(file.file.type) }}</mat-icon>
                    <span>{{ file.file.name }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Country Column -->
              <ng-container matColumnDef="country">
                <th mat-header-cell *matHeaderCellDef>Country</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="country-input">
                    <input matInput [value]="file.country || 'US'" disabled placeholder="US">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="type-select">
                    <mat-select [(value)]="file.type" (selectionChange)="updateFileType(file, $event.value)">
                      <mat-option *ngFor="let option of getTypeOptions()" [value]="option">
                        {{ option }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Acct SOR Column -->
              <ng-container matColumnDef="acctSor">
                <th mat-header-cell *matHeaderCellDef>Acct SOR</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="sor-input">
                    <input matInput [(ngModel)]="file.acctSor" (input)="updateAcctSor(file, $event.target.value)" placeholder="Enter Acct SOR">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Deal SOR Column -->
              <ng-container matColumnDef="dealSor">
                <th mat-header-cell *matHeaderCellDef>Deal SOR</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="sor-input">
                    <input matInput [(ngModel)]="file.dealSor" (input)="updateDealSor(file, $event.target.value)" placeholder="Enter Deal SOR">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Acct LOB Column -->
              <ng-container matColumnDef="acctLob">
                <th mat-header-cell *matHeaderCellDef>Acct LOB</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="lob-input">
                    <input matInput [(ngModel)]="file.acctLob" (input)="updateAcctLob(file, $event.target.value)" placeholder="Enter Acct LOB">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- RCC Code Column -->
              <ng-container matColumnDef="rccCode">
                <th mat-header-cell *matHeaderCellDef>RCC Code</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="rcc-input">
                    <input matInput [(ngModel)]="file.rccCode" (input)="updateRccCode(file, $event.target.value)" placeholder="Enter RCC Code">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Existing RCC Code Column -->
              <ng-container matColumnDef="existingRccCode">
                <th mat-header-cell *matHeaderCellDef>Existing RCC</th>
                <td mat-cell *matCellDef="let file">
                  <mat-form-field appearance="outline" class="rcc-input">
                    <input matInput [(ngModel)]="file.existingRccCode" (input)="updateExistingRccCode(file, $event.target.value)" placeholder="Enter Existing RCC">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let file">
                  <div class="status-cell">
                    <mat-icon class="status-icon" [class]="file.status">
                      {{ file.status === 'completed' ? 'check_circle' : 'error' }}
                    </mat-icon>
                    <span class="status-text" [class]="file.status">{{ file.status | titlecase }}</span>
                    <!-- Progress Bar -->
                    <mat-progress-bar 
                      *ngIf="file.status === 'uploading'"
                      [value]="file.progress"
                      class="progress-bar"
                    ></mat-progress-bar>
                    <!-- Conflict Indicator -->
                    <div class="conflict-indicator" *ngIf="submissionCompleted && file.conflict">
                      <mat-icon class="conflict-icon">warning</mat-icon>
                      <span class="conflict-text">Conflict</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let file; let i = index">
                  <div class="actions-cell">
                    <button 
                      mat-icon-button 
                      (click)="toggleRowExpansion(i)"
                      matTooltip="View details"
                      class="expand-button"
                      [class.expanded]="isRowExpanded(i)"
                    >
                      <mat-icon>{{ isRowExpanded(i) ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      (click)="removeFile(i)"
                      matTooltip="Remove file"
                      class="remove-button"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                    <button 
                      mat-icon-button 
                      *ngIf="file.status === 'error'"
                      (click)="retryUpload(file)"
                      matTooltip="Retry upload"
                    >
                      <mat-icon>refresh</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- Expanded Detail Row -->
              <ng-container matColumnDef="expandedDetail">
                <td mat-cell *matCellDef="let detail" [attr.colspan]="8">
                  <div class="expanded-detail" *ngIf="isRowExpanded(detail.index)">
                    <div class="detail-header">
                      <h4>File Details</h4>
                      <span class="detail-subtitle">Comprehensive information about {{ detail.fileName }}</span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['fileName', 'country', 'type', 'acctSor', 'dealSor', 'acctLob', 'rccCode', 'existingRccCode', 'status', 'actions']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['fileName', 'country', 'type', 'acctSor', 'dealSor', 'acctLob', 'rccCode', 'existingRccCode', 'status', 'actions'];" 
                  [class.expanded-row]="row.isExpanded"
                  [class]="getRowClass(row)"></tr>
              <tr mat-row *matRowDef="let row; when: isExpansionDetailRow" 
                  [class.expansion-detail-row]="true"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- API Response Results -->
      <div class="results-section" *ngIf="showResults && apiResponse">
        <mat-card class="results-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon class="result-icon" [class]="apiResponse.summary.failed > 0 ? 'error' : 'success'">
                {{ apiResponse.summary.failed > 0 ? 'error' : 'check_circle' }}
              </mat-icon>
              Submission Results
            </mat-card-title>
            <mat-card-subtitle>
              {{ apiResponse.message }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <!-- Summary Information -->
            <div class="summary-section">
              <h4>Summary</h4>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="label">Total Files:</span>
                  <span class="value">{{ apiResponse.summary.total_files }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Successful:</span>
                  <span class="value success">{{ apiResponse.summary.successful }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Failed:</span>
                  <span class="value error">{{ apiResponse.summary.failed }}</span>
                </div>
              </div>
            </div>

            <!-- File Details -->
            <div class="file-details-section" *ngIf="apiResponse.results?.length">
              <h4>File Details</h4>
              <mat-list class="result-file-list">
                <mat-list-item *ngFor="let file of apiResponse.results" class="result-file-item">
                  <div class="result-file-content">
                    <mat-icon class="file-status-icon" [class]="file.status">
                      {{ file.status === 'success' ? 'check_circle' : 'error' }}
                    </mat-icon>
                    <div class="result-file-info">
                      <!-- Filename with edit functionality -->
                      <div class="result-file-name">
                        <div *ngIf="!isEditing(file.fileName)" class="filename-display">
                          <span>{{ file.fileName }}</span>
                          <button 
                            mat-icon-button 
                            (click)="startEditFileName(file.fileName)"
                            class="edit-button"
                            matTooltip="Edit filename"
                          >
                            <mat-icon>edit</mat-icon>
                          </button>
                        </div>
                        <div *ngIf="isEditing(file.fileName)" class="filename-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editedFileName"
                            class="filename-input"
                            (keyup.enter)="saveFileName(file)"
                            (keyup.escape)="cancelEditFileName()"
                            #filenameInput
                            autofocus
                          >
                          <div class="edit-actions">
                            <button 
                              mat-icon-button 
                              (click)="saveFileName(file)"
                              class="save-button"
                              matTooltip="Save"
                            >
                              <mat-icon>check</mat-icon>
                            </button>
                            <button 
                              mat-icon-button 
                              (click)="cancelEditFileName()"
                              class="cancel-button"
                              matTooltip="Cancel"
                            >
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="result-file-meta">
                        {{ formatFileSize(file.fileSize) }}
                        <span class="file-id" *ngIf="file.fileId">• ID: {{ file.fileId }}</span>
                      </div>
                      <div class="file-status" [class]="file.status">
                        {{ file.status | titlecase }}
                      </div>
                      <div class="file-error" *ngIf="file.error">
                        <mat-icon class="error-icon">error</mat-icon>
                        <span class="error-text">{{ file.error }}</span>
                      </div>
                    </div>
                  </div>
                </mat-list-item>
              </mat-list>
            </div>

            <!-- Failed Files Section -->
            <div class="failed-files-section" *ngIf="apiResponse.failed_files?.length">
              <h4>Failed Files</h4>
              <mat-list class="failed-files-list">
                <mat-list-item *ngFor="let file of apiResponse.failed_files" class="failed-file-item">
                  <div class="failed-file-content">
                    <mat-icon class="error-icon">error</mat-icon>
                    <div class="failed-file-info">
                      <!-- Filename with edit functionality -->
                      <div class="failed-file-name">
                        <div *ngIf="!isEditing(file.fileName)" class="filename-display">
                          <span>{{ file.fileName }}</span>
                          <button 
                            mat-icon-button 
                            (click)="startEditFileName(file.fileName)"
                            class="edit-button"
                            matTooltip="Edit filename"
                          >
                            <mat-icon>edit</mat-icon>
                          </button>
                        </div>
                        <div *ngIf="isEditing(file.fileName)" class="filename-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editedFileName"
                            class="filename-input"
                            (keyup.enter)="saveFileName(file)"
                            (keyup.escape)="cancelEditFileName()"
                            autofocus
                          >
                          <div class="edit-actions">
                            <button 
                              mat-icon-button 
                              (click)="saveFileName(file)"
                              class="save-button"
                              matTooltip="Save"
                            >
                              <mat-icon>check</mat-icon>
                            </button>
                            <button 
                              mat-icon-button 
                              (click)="cancelEditFileName()"
                              class="cancel-button"
                              matTooltip="Cancel"
                            >
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="failed-file-meta">
                        {{ formatFileSize(file.fileSize) }}
                      </div>
                      <div class="failed-file-error" *ngIf="file.error">
                        <span class="error-text">{{ file.error }}</span>
                      </div>
                    </div>
                  </div>
                </mat-list-item>
              </mat-list>
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="uploadNewFiles()"
              class="upload-new-button"
            >
              <mat-icon>add</mat-icon>
              Upload New Files
            </button>
            <button 
              mat-button 
              (click)="clearResults()"
              class="clear-results-button"
            >
              <mat-icon>clear</mat-icon>
              Clear Results
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="uploadedFiles.length === 0">
        <mat-icon class="empty-icon">folder_open</mat-icon>
        <p>No files uploaded yet</p>
        <p class="empty-subtitle">Start by dragging files here or clicking the upload button</p>
      </div>
    </mat-card-content>
  </mat-card>
</div> 